{% extends "layout.html" %}
{% block body %}
  <div class="row">
    <div class="col s3 m3">
    <h3>
      {{ resource['description'] }}
    </h3>
    </div>
  </div>
  <div class="row">
    <div class="col s12">
      <form class="col s12" id="ticketForm">
          <div class="input-field col s12">
            <i class="material-icons prefix">info_outline</i>
            <input id="title" type="text">
            <label for="title">Titulo</label>
          </div>
          <div class="input-field col s12">
            <i class="material-icons prefix">perm_identity</i>
            <input id="asignee" type="text">
            <label for="asignee">¿A quién se le asigna el ticket?</label>
          </div>
          <div class="input-field col s12">
            <i class="material-icons prefix">perm_identity</i>
            <input id="reporter" type="text">
            <label for="reporter">¿Quién reporta el problema?</label>
          </div>
          <div class="input-field col s12">
            <i class="material-icons prefix">mode_edit</i>
            <textarea id="description" class="materialize-textarea"></textarea>
            <label for="description">Problema a reportar</label>
          </div>
      </form>
      <center>
        <a id='submitForm' class="waves-effect waves-light btn" onclick="saveForm()"><i class="material-icons left">add</i>Guardar</a>
      </center>
    </div>
  </div>
  <div class="row">
    <div id="tickets">
    </div>
  </div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
  function loadTickets() {
    $.ajax({
      url: '/api/resources' + window.location.pathname + '/tickets',
      dataType: 'json'
    }).done(function(data) {
      console.log(data);
      var html = '';
      if (data.length > 0) {
        html += '<h4>Tickets</h4>';
      }
      for (var i = data.length - 1; i >= 0; i--) {
        html += '<div class="col s12 m6">';
        html += '<div class="card blue-grey darken-1">';
        html += '<div class="card-content white-text">';
        html += '<span class="card-title">' + data[i].title + '</span>';
        html += '<p>' + data[i].description + '</p>';
        html += '<ul>';
        html += '<li> Ticket Asignado a:' + data[i].asignee + '</li>';
        html += '<li> Persona que asigna el ticket:' + data[i].reporter + '</li>';
        html += '</ul>';
        html += '<div class="card-action">';
        html += '<a id="' + data[i].id + '" href="javascript:void(0);" onclick="deleteTicket(this.id)">Ticket finalizado</a>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
      $("#tickets").html(html);
    });
  }

  function saveForm() {
    $.ajax({
      type: 'POST',
      url: '/api/resources' + window.location.pathname + '/tickets',
      contentType: 'application/json',
      data: JSON.stringify({
        title: $("#title").val(),
        asignee: $("#asignee").val(),
        reporter: $("#reporter").val(),
        description: $("#description").val()
      })
    }).done(function(data) {
      console.log(data);
      $("#title").val('');
      $("#asignee").val('');
      $("#reporter").val('');
      $("#description").val('');
      Materialize.toast('Se guardó el ticket de manera exitosa', 3000);
      loadTickets();
    }).error(function(data) {
      console.log(data);
      Materialize.toast('No se pudó guardar el ticket', 4000)
    });
  }

  function deleteTicket(id) {
    $.ajax({
      type: 'DELETE',
      url: '/api/resources' + window.location.pathname + '/tickets/' + id,
      dataType: 'json'
    }).done(function(data) {
      console.log(data);
      loadTickets();
      Materialize.toast('Se borró el ticket de manera exitosa', 3000);
    });
  }

  $(function() {
    loadTickets();
  });

</script>
{% endblock %}